<div
  class="mx-auto flex max-w-[1440px] flex-col gap-4 p-6"
  [style.view-transition-name]="showTransition ? 'detail' : null"
>
  <div class="justify-between md:flex">
    <header class="grow">
      <button
        mat-icon-button
        (click)="goBack()"
        data-umami-event="Access Grant Manager Back Link Clicked"
        aria-label="Go back to previous page"
        class="text-primary float-left mt-1 mr-4"
      >
        <mat-icon fontIcon="chevron_left"></mat-icon>
      </button>
      <h1>Access Grant Detail</h1>
    </header>
  </div>

  @if (grant(); as ag) {
  <div class="flex w-full items-center justify-between">
    <div>
      <p>
        <strong>Status:</strong>&nbsp;<span
          class="{{ ag?.status | AccessGrantStatusClassPipe }} capitalize w-24"
          >{{ ag.status }}</span
        >
      </p>

      <p>
        <strong>Dataset:</strong>&nbsp;<span class="w-24 capitalize"
          ><a
            routerLink="/dataset/{{ ag?.dataset_id }}"
            data-umami-event="Access Grant Details Dataset Clicked"
            >{{ ag?.dataset_id }}</a
          ></span
        >
      </p>
    </div>
    @if (ag.status !== 'expired') {
    <div class="w-64">
      <button
        mat-raised-button
        matTooltip="Revoke Access Grant"
        aria-label="Revoke Access Grant"
        (click)="openRevokeDialog()"
      >
        Revoke Access Grant
        <mat-icon fontIcon="block"></mat-icon>
      </button>
    </div>
    }
  </div>
  <div class="grid grid-cols-1 gap-4 xl:grid-cols-2">
    <div
      class="*:smaller-mat-card-title my-2 flex flex-col items-start gap-4 *:w-full *:overflow-x-auto"
    >
      <mat-card>
        <mat-card-header>
          <mat-card-title><h2>Grantee</h2></mat-card-title>
        </mat-card-header>
        <mat-card-content class="min-w-2xl md:min-w-xl">
          <p>
            <strong class="inline-block w-44">Email:</strong>
            <a appExtLink [href]="'mailto:' + ag.user_email" tabindex="-1"
              >{{ ag.user_email }}</a
            >
          </p>
          <p>
            <strong class="inline-block w-44">Name:</strong>
            <a [routerLink]="'/user-manager/' + ag.user_id"
              >{{ ag.user_title }} {{ ag.user_name }}</a
            >
          </p>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title><h2>DAC and Access Request</h2></mat-card-title>
        </mat-card-header>
        <mat-card-content class="min-w-2xl md:min-w-xl">
          <p>
            <strong class="inline-block w-44">DAC:</strong>
            <span>{{ ag.dac_alias }}</span>
          </p>
          <p>
            <strong class="inline-block w-44">DAC Email:</strong>
            <span
              ><a appExtLink [href]="'mailto:' + ag.dac_email" tabindex="-1"
                >{{ ag.dac_email }}</a
              ></span
            >
          </p>

          @switch (ar().length) { @case (0) {
          <p>
            <span
              ><span class="warn"
                >No access request was matched for this grant!</span
              ></span
            >
          </p>
          } @case (1) { @let request = ar()[0];
          <p class="flex">
            <strong class="inline-block min-w-44">Access Request:</strong>
            <span
              >for the dataset
              <a
                routerLink="/dataset/{{ request.dataset_id }}"
                data-umami-event="Access Grant Details Access Requests List Dataset Clicked"
                >{{ request.dataset_id }}</a
              ><br />
              from {{ request.access_starts | date: friendlyDateFormat : periodTimeZone
              }} to {{ request.access_ends | date: friendlyDateFormat : periodTimeZone
              }}</span
            >
          </p>
          } @default {
          <p>
            <span class="text-warning flex pt-2"
              ><mat-icon fontIcon="warning" class="me-1"></mat-icon>Warning: Found
              multiple requests by this user for this dataset!</span
            >
          </p>

          @for (request of ar(); track request.id) {
          <p class="flex">
            <strong class="inline-block w-44">Access Request:</strong>
            <span
              >For the dataset
              <a
                class="text-quaternary hover:text-secondary focus:text-secondary"
                routerLink="/dataset/{{ request.dataset_id }}"
                data-umami-event="Granted Access Requests List Dataset Clicked"
                >{{ request.dataset_id }}</a
              ><br />
              from {{ request.access_starts | date: friendlyDateFormat : periodTimeZone
              }} to {{ request.access_ends | date: friendlyDateFormat : periodTimeZone
              }}.</span
            >
          </p>
          } } }
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title><h2>IVA & Status</h2></mat-card-title>
        </mat-card-header>
        <mat-card-content
          class="min-w-2xl *:mb-2 *:flex md:min-w-xl [&_div>strong]:inline-block [&_div>strong]:min-w-44"
        >
          @if (iva(); as iva) { @if (iva.user_id !== ag.user_id) {
          <strong class="text-error flex items-center pb-2"
            ><mat-icon fontIcon="error" class="me-1 shrink-0"></mat-icon> The IVA does
            not belong to the same user as the access grant. The access grant is
            therefore invalid.</strong
          >
          <div>
            <strong>User:</strong
            ><span
              ><a [routerLink]="`/user-manager/${iva.user_id}`"
                >{{ iva.user_name }} ({{iva.user_email}})</a
              ></span
            >
          </div>
          }
          <div>
            <strong>Type:</strong>
            <span class="flex"
              ><mat-icon [fontIcon]="(iva.type | IvaTypePipe).icon"></mat-icon>{{
              (iva.type | IvaTypePipe).name }}</span
            >
          </div>
          <div>
            <strong>Value:</strong>
            <span>{{ iva.value }}</span>
          </div>
          <div>
            <strong>State:</strong>
            <span [class]="(iva.state | IvaStatePipe).class"
              >{{ (iva.state | IvaStatePipe).name }}</span
            >
          </div>
          <div class="mt-4">
            <a routerLink="/iva-manager">Go to IVA manager</a>
          </div>
          } @else {
          <strong class="text-error"
            >IVA details could not be loaded. Please try again later or contact your
            administrator if the issue persists.</strong
          >
          }
        </mat-card-content>
      </mat-card>
    </div>
    <div
      class="*:smaller-mat-card-title my-2 flex flex-col items-start gap-4 *:w-full *:overflow-x-auto"
    >
      <mat-card>
        <mat-card-header>
          <mat-card-title><h2>Audit Log</h2></mat-card-title>
        </mat-card-header>
        <mat-card-content class="divide-outline divide-y">
          @if (ar().length > 0) { @for (item of sortedArLog(); track item) { @if
          (item.date) {
          <p class="mb-2 pb-2">
            <strong class="inline-block w-44 xl:w-32">{{ item.date | date }}</strong>
            <span>Access {{item.status}}</span>
          </p>
          } } }
          <p class="mb-2 pb-2">
            <strong class="inline-block w-44 xl:w-32">{{ ag.created | date }}</strong>
            <span>Grant created</span>
          </p>
          @if (hasStarted()) {
          <p class="mb-2 pb-2">
            <strong class="inline-block w-44 xl:w-32"
              >{{ ag.valid_from | date }}</strong
            >
            <span>Grant started</span>
          </p>
          } @if (hasEnded()) {
          <p class="mb-2 pb-2">
            <strong class="inline-block w-44 xl:w-32"
              >{{ ag.valid_until | date }}</strong
            >
            <span>Grant expired</span>
          </p>
          }
        </mat-card-content>
      </mat-card>
    </div>
  </div>
  } @else {
  <div class="container mx-auto p-6">
    <p class="text-center text-red-600">
      @if (!grant()) { The selected access grant could not be found. } @else { An error
      occurred while loading the access grant details. Please try again later. }
    </p>
  </div>
  }
</div>
