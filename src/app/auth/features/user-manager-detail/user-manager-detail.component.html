<div
  class="mx-auto flex max-w-[1440px] flex-col gap-6 p-6"
  [style.view-transition-name]="showTransition ? 'detail' : null"
>
  <div class="clearfix mb-6">
    <button
      mat-icon-button
      (click)="goBack()"
      data-umami-event="User Manager Back Link Clicked"
      aria-label="Go back to previous page"
      class="text-primary float-left mt-1 mr-4"
    >
      <mat-icon>chevron_left</mat-icon>
    </button>
    <h1>User{{ user() ? ': ' + user()!.displayName : ' Details' }}</h1>
  </div>
  @if (user(); as user) {
    <mat-card
      ><mat-card-content class="overflow-x-auto">
        <div class="flex flex-col gap-6 lg:grid lg:grid-cols-2">
          <div class="space-x-3 text-end lg:col-start-2 lg:w-full">
            @if (user.status === 'active') {
              <button
                matIconButton
                matTooltip="Deactivate User"
                aria-label="Deactivate User"
                (click)="safeStatusChange()"
              >
                <mat-icon>person_remove</mat-icon>
              </button>
            } @else {
              <button
                matIconButton
                matTooltip="Activate User"
                aria-label="Activate User"
                (click)="safeStatusChange(true)"
              >
                <mat-icon>person_check</mat-icon>
              </button>
            }
            <button
              matIconButton
              class="remove-user"
              matTooltip="Delete User"
              aria-label="Delete User"
              (click)="safeDeletion()"
            >
              <mat-icon>person_off</mat-icon>
            </button>
          </div>

          <div>
            <h2 class="mb-4 font-semibold">Basic Information</h2>
            <div class="space-y-3">
              <div>
                <strong>Name:</strong>
                <p class="mt-1 text-gray-900">{{ user.name }}</p>
              </div>
              @if (user.title) {
                <div>
                  <strong>Title:</strong>
                  <p class="mt-1 text-gray-900">{{ user.title }}</p>
                </div>
              }
              <div>
                <strong>Email:</strong>
                <p class="mt-1 text-gray-900">{{ user.email }}</p>
              </div>
            </div>
          </div>

          <div>
            <h2 class="mb-4 text-xl font-semibold">Account Details</h2>
            <div class="space-y-3">
              <div>
                <strong>Status:</strong>
                <p
                  class="mt-1 capitalize"
                  [class]="user.status === 'active' ? 'text-green-600' : 'text-red-600'"
                >
                  {{ user.status }}
                </p>
              </div>
              <div>
                <strong>Registration Date:</strong>
                <p class="mt-1 text-gray-900">
                  {{ user.registration_date | date: friendlyDateFormat }}
                </p>
              </div>
              <div>
                <strong>Roles:</strong>
                <div class="mt-1 flex flex-wrap gap-1">
                  @for (roleName of user.roleNames; track roleName) {
                    <mat-chip>{{ roleName }}</mat-chip>
                  } @empty {
                    <p class="text-gray-500">No roles assigned</p>
                  }
                </div>
              </div>
            </div>
          </div>

          <!-- External ID in full row -->
          <div class="col-span-2 pt-6">
            <div>
              <strong>Life Science (LS) ID:</strong>
              <p class="mt-1 font-mono break-all text-gray-900">
                {{ user.ext_id }}
              </p>
            </div>
          </div>
        </div></mat-card-content
      ></mat-card
    >

    <mat-card
      ><mat-card-header
        ><mat-card-title><h2>IVAs</h2></mat-card-title></mat-card-header
      >
      <mat-card-content
        class="divide-outline space-y-3 divide-y-1 divide-solid overflow-x-auto"
      >
        @if (userIvas().length) {
          @for (iva of userIvas(); track iva.id) {
            <div class="flex min-w-2xl items-center gap-x-4 gap-y-4 pb-3">
              <span class="min-w-42"
                ><strong>{{ (iva.type | IvaTypePipe).name }}:</strong></span
              >
              <span class="min-w-54 grow">{{ iva.value }}</span>

              <span [class]="(iva.state | IvaStatePipe).class" class="min-w-60">
                {{ (iva.state | IvaStatePipe).name }}
              </span>
            </div>
          }
        } @else {
          <p>No contact addresses could be found for the user.</p>
        }
      </mat-card-content>
    </mat-card>

    <mat-card
      ><mat-card-header
        ><mat-card-title><h2>Access Grants</h2></mat-card-title></mat-card-header
      >
      <mat-card-content
        class="divide-outline space-y-3 divide-y-1 divide-solid overflow-x-auto"
      >
        @if (userGrants().length) {
          @for (ag of userGrants(); track ag.id) {
            <div class="min-w-xl">
              <p>
                <a [routerLink]="`/access-grant-manager/${ag.id}`">Grant</a> for the
                dataset
                <a [routerLink]="`/dataset/${ag.dataset_id}`">{{ ag.dataset_id }}</a>
                from {{ ag.access_starts | date: friendlyDateFormat }} to
                {{ ag.access_ends | date: friendlyDateFormat }}
              </p>
            </div>
          }
        } @else {
          <p>No access requests could be found for the user.</p>
        }
      </mat-card-content>
    </mat-card>

    <mat-card
      ><mat-card-header
        ><mat-card-title><h2>Access Requests</h2></mat-card-title></mat-card-header
      >
      <mat-card-content
        class="divide-outline space-y-3 divide-y-1 divide-solid overflow-x-auto"
      >
        @if (userRequests().length) {
          @for (ar of userRequests(); track ar.id) {
            <div class="min-w-xl">
              <p [class.lg:zero-p-margin]="ar.internal_note">
                <span class="{{ ar.status | AccessRequestStatusClassPipe }} capitalize">
                  {{ ar.status }}
                </span>
                <a [routerLink]="`/access-request-manager/${ar.id}`">request</a> for the
                dataset
                <a [routerLink]="`/dataset/${ar.dataset_id}`">{{ ar.dataset_id }}</a>
                from {{ ar.access_starts | date: friendlyDateFormat }} to
                {{ ar.access_ends | date: friendlyDateFormat }}
              </p>
              @if (ar.internal_note) {
                <p class="text-gray">
                  <strong>Internal Note:</strong> {{ ar.internal_note }}
                </p>
              }
            </div>
          }
        } @else {
          <p>No access requests could be found for the user.</p>
        }
      </mat-card-content>
    </mat-card>
  } @else if (loading()) {
    <p>Loading user details...</p>
  } @else {
    <div class="container mx-auto p-6">
      <p class="text-center text-red-600">
        @if (error() === 'not found') {
          The selected user could not be found.
        } @else {
          An error occurred while loading the user details. Please try again later.
        }
      </p>
    </div>
  }
</div>
